<html>
  <head>
    <title>Auto pong WASM</title>
  </head>
  <body>
    <canvas id="app" width="1600" height="900"></canvas>
    <script >
        let ctx;
        let allocated; // A global reference of the WASMâ€™s memory area so that we can look up pointers
        let function_table;
        let update_frame = () => {};

        function parseColor(color) {
            // Color comes in as 0xAABBGGRR format
            const a = ((color >>> 24) & 0xFF).toString(16).padStart(2, '0');  // Alpha
            const b = ((color >>> 16) & 0xFF).toString(16).padStart(2, '0');  // Blue
            const g = ((color >>> 8) & 0xFF).toString(16).padStart(2, '0');   // Green
            const r = ((color >>> 0) & 0xFF).toString(16).padStart(2, '0');   // Red
            return '#' + r + g + b + a;
        }

        const exported_js_functions = {
            set_canvas_size: (width, height) => {
                ctx.canvas.width = width;
                ctx.canvas.height = height;
            },
            fill_rect: (x, y, w, h, color) => {
                const unsignedColor = color >>> 0;
                ctx.fillStyle = parseColor(unsignedColor);
                ctx.fillRect(x, y, w, h);
            },
            set_update_frame: (f) => {
                update_frame = function_table.get(Number(f));
            },
            clear_background: (color) => {
                const unsignedColor = color >>> 0;
                ctx.fillStyle = parseColor(unsignedColor);
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            },
        }

        // Create the environment for the WASM file,
        // which includes the exported JS functions for the WASM:
        const imports = {
            "env": new Proxy(exported_js_functions, {
                get(target, prop, receiver) {
                    if (target.hasOwnProperty(prop)) {
                        return target[prop];
                    }

                    return () => { throw new Error("Missing function: " + prop); };
                },
            }),
        }


        WebAssembly.instantiateStreaming(fetch("game.wasm"), imports).then(
            (wasm) => {
                console.log(wasm);
                allocated = wasm.instance.exports.memory;
                function_table = wasm.instance.exports.__indirect_function_table;


                const app = document.getElementById("app");
                ctx = app.getContext("2d");
                ctx.fillStyle = '#333333';
                ctx.fillRect(0, 0, app.width, app.height);

                let prevTimestamp;
                function frame(timestamp) {
                    const deltaTime = (timestamp - prevTimestamp)*0.001;
                    prevTimestamp = timestamp;
                    update_frame(deltaTime);
                    window.requestAnimationFrame(frame);
                }
                window.requestAnimationFrame((timestamp) => {
                    prevTimestamp = timestamp;
                    window.requestAnimationFrame(frame);
                });

                wasm.instance.exports.main();
            }
        )
    </script>
  </body>
</html>